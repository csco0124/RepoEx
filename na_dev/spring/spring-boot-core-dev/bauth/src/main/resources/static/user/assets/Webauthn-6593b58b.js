import{$ as u,i as d,a8 as C}from"./index-98646e71.js";import{a as w}from"./validateUtil-0f34513f.js";function p(t){const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",r=new Uint8Array(256);for(var e=0;e<a.length;e++)r[a.charCodeAt(e)]=e;for(var n=t.length,o=t.charAt(n-2)==="="?2:t.charAt(n-1)==="="?1:0,i=n*3/4-o,c=new ArrayBuffer(i),s=new Uint8Array(c),h=0,e=0;e<n;e+=4){var y=r[t.charCodeAt(e)],g=r[t.charCodeAt(e+1)],m=r[t.charCodeAt(e+2)],f=r[t.charCodeAt(e+3)];s[h++]=y<<2|g>>4,s[h++]=(g&15)<<4|m>>2,s[h++]=(m&3)<<6|f&63}return c}function l(t){const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",r=new Uint8Array(256);for(var e=0;e<a.length;e++)r[a.charCodeAt(e)]=e;for(var n=new Uint8Array(t),o=n.length,i="",e=0;e<o;e+=3)i+=a[n[e]>>2],i+=a[(n[e]&3)<<4|n[e+1]>>4],i+=a[(n[e+1]&15)<<2|n[e+2]>>6],i+=a[n[e+2]&63];switch(o%3){case 1:i=i.substring(0,i.length-2);break;case 2:i=i.substring(0,i.length-1);break}return i}async function E(t,a){const r=await O("required");if(r=="regist"){t();return}return await navigator.credentials.get(r).then(e=>{const n=new FormData;return n.append("credentialId",e.id),n.append("clientDataJSON",l(e.response.clientDataJSON)),n.append("authenticatorData",l(e.response.authenticatorData)),n.append("signature",l(e.response.signature)),n.append("clientExtensions",JSON.stringify(e.getClientExtensionResults())),n.append("remember-me",a),u.post("/webauthn/login",n).then(o=>location.href=o.data.data.targetUrl),"success"}).catch(e=>(console.error("Error:%s, Message:%s",e.name,e.message),"error"))}function b(){let t="";return t=C("webauthnEmail"),!d(localStorage.getItem("email"))&&d(t)&&(t=localStorage.getItem("email")),t}async function O(t){const a=b();return d(a)?"regist":await u.get("/webauthn/assertion/options?email="+encodeURIComponent(a)).then(r=>{const e=r.data;return e.allowCredentials.length==0?"regist":{publicKey:{challenge:p(e.challenge),timeout:e.timeout,rpId:e.rpId,allowCredentials:e.allowCredentials.map(i=>({type:i.type,id:p(i.id)})),userVerification:t,extensions:e.extensions}}})}async function v(t,a){let r=a.email,e=a.userHandle;return await u.get("/webauthn/attestation/options").then(n=>{const o=n.data;let i=[];return{publicKey:{rp:{id:o.rp.id,name:o.rp.name},user:{id:p(e),name:r,displayName:r},challenge:p(o.challenge),pubKeyCredParams:o.pubKeyCredParams,timeout:o.timeout,excludeCredentials:i,authenticatorSelection:{authenticatorAttachment:o.authenticatorSelection.authenticatorAttachment,requireResidentKey:t,residentKey:o.authenticatorSelection.residentKey,userVerification:o.authenticatorSelection.userVerification},attestation:o.attestation,extensions:o.extensions}}})}async function A(t,a){const r=await v(t,a);return await navigator.credentials.create(r).then(function(e){return{credentialId:l(e.rawId),clientDataJSON:l(e.response.clientDataJSON),attestationObject:l(e.response.attestationObject),clientExtensions:JSON.stringify(e.getClientExtensionResults()),type:e.type}}).catch(function(e){console.error("Error:%s, Message:%s",e.name,e.message)})}async function K(t,a,r,e){await A(!0,a).then(n=>{if(d(n)){console.log("credential is empty");return}const o=[{id:"",name:"authenticator",credentialId:n.credentialId,clientDataJSON:n.clientDataJSON,attestationObject:n.attestationObject,clientExtensions:n.clientExtensions}],i={username:a.username,userHandle:a.userHandle,email:a.email,authenticators:o};let c="/public/api/profile";return w(e)&&(i.secretKey=a.secretKey,c+=`/${e}`),u.post(c,i).then(s=>{if(s.data.error!="OK"){console.log(s.data.message);return}localStorage.setItem("email",s.data.data.email),t({message:"등록이 완료되었습니다.",onClose:()=>{r()}})}).catch(()=>{console.log("webauthn 등록 에러")}),i})}function D(t){u.get("/auth/api/webauthn/profile?userId="+t.userId).then(a=>{if(a.data.error!="OK"){console.log(a.data.message);return}const r=a.data.data;r.secretKey=t.secretKey,K(t.alert,r,t.callbackFn,t.verifySocialId)})}async function R(t){const a={username:t.username,userHandle:t.userHandle,email:t.email,authenticators:[]};let r=!1;return await u.post("/public/api/profile",a).then(e=>{e.data.error=="OK"&&(r=!0)}),r}export{D as a,R as d,K as r,E as w};
